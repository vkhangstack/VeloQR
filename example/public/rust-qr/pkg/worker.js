let wasmModule=null,isInitialized=!1;async function initializeWasm(t,e){if(isInitialized&&wasmModule)return{success:!0};try{const a=await fetch(t);if(!a.ok)throw new Error(`Failed to load WASM: ${a.status}`);const i=await a.arrayBuffer(),n=await fetch(e);if(!n.ok)throw new Error(`Failed to load WASM JS: ${n.status}`);const o=await n.text(),s=new Blob([o],{type:"application/javascript"}),r=URL.createObjectURL(s);try{return wasmModule=await import(r),await wasmModule.default(i),isInitialized=!0,URL.revokeObjectURL(r),{success:!0}}catch(t){throw URL.revokeObjectURL(r),t}}catch(t){return{success:!1,error:t.message}}}function generateSlidingWindows(t,e,a=[1,.75,.5],i=.25,n=10){const o=[];for(const s of a){const a=Math.floor(t*s),r=Math.floor(e*s),d=Math.max(1,Math.floor(a*i)),c=Math.max(1,Math.floor(r*i));for(let i=0;i<=e-r;i+=c)for(let e=0;e<=t-a;e+=d)if(o.push({x:e,y:i,width:a,height:r,scale:s}),n&&o.length>=n)return o}return o}function extractWindow(t,e){const{x:a,y:i,width:n,height:o}=e,{data:s,width:r}=t,d=new Uint8ClampedArray(n*o*4);for(let t=0;t<o;t++)for(let e=0;e<n;e++){const o=4*((i+t)*r+(a+e)),c=4*(t*n+e);d[c]=s[o],d[c+1]=s[o+1],d[c+2]=s[o+2],d[c+3]=s[o+3]}return{data:d,width:n,height:o}}function isDuplicate(t,e){if(t.data!==e.data)return!1;if(t.bounds&&e.bounds&&t.bounds.length>=4&&e.bounds.length>=4){const a={minX:Math.min(...t.bounds.map(t=>t[0])),maxX:Math.max(...t.bounds.map(t=>t[0])),minY:Math.min(...t.bounds.map(t=>t[1])),maxY:Math.max(...t.bounds.map(t=>t[1]))},i={minX:Math.min(...e.bounds.map(t=>t[0])),maxX:Math.max(...e.bounds.map(t=>t[0])),minY:Math.min(...e.bounds.map(t=>t[1])),maxY:Math.max(...e.bounds.map(t=>t[1]))},n=Math.max(0,Math.min(a.maxX,i.maxX)-Math.max(a.minX,i.minX))*Math.max(0,Math.min(a.maxY,i.maxY)-Math.max(a.minY,i.minY)),o=(a.maxX-a.minX)*(a.maxY-a.minY),s=(i.maxX-i.minX)*(i.maxY-i.minY);return n/o>.5||n/s>.5}return!0}function deduplicateResults(t){const e=[];for(const a of t){!e.some(t=>isDuplicate(t,a))&&e.push(a)}return e}function decodeWindow(t){if(!isInitialized||!wasmModule)throw new Error("WASM not initialized");try{const{data:e,width:a,height:i}=t;return wasmModule.decode_qr_from_image(e,a,i)||[]}catch(t){return[]}}function decodeQRCode(t,e=!1,a=[1,.75,.5],i=.25,n=10){if(!isInitialized||!wasmModule)throw new Error("WASM not initialized");try{if(!e)return decodeWindow(t);const o=[],s=decodeWindow(t);if(o.push(...s),s.length>0)return s;const r=generateSlidingWindows(t.width,t.height,a,i,n);for(const e of r){const a=decodeWindow(extractWindow(t,e));for(const t of a)t.bounds&&(t.bounds=t.bounds.map(([t,a])=>[t+e.x,a+e.y])),o.push(t);if(a.length>0)break}return deduplicateResults(o)}catch(t){return[]}}function extractMRZ(t){if(!isInitialized||!wasmModule)throw new Error("WASM not initialized");try{return wasmModule.parse_mrz_text(t)||{}}catch(t){return{}}}self.onmessage=async function(t){const{type:e,id:a,payload:i}=t.data;try{switch(e){case"init":{const t=await initializeWasm(i.wasmUrl,i.wasmJsUrl);self.postMessage({type:"init-response",id:a,success:t.success,error:t.error});break}case"decode":{const t=decodeQRCode(i.imageData,i.useSlidingWindow,i.scales,i.stride,i.maxWindows);self.postMessage({type:"decode-response",id:a,results:t});break}case"terminate":wasmModule=null,isInitialized=!1,self.close()}}catch(t){self.postMessage({type:e+"-error",id:a,error:t.message})}};